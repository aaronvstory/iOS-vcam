# SRS Configuration - iPhone RTMP Optimized (Green Bars & Lag Fixed)
# Designed to eliminate video artifacts and reduce latency for iOS clients

listen              192.168.50.9:1935;
max_connections     1000;
daemon              off;
srs_log_tank        console;

http_api {
    enabled         on;
    listen          192.168.50.9:1985;
}

http_server {
    enabled         on;
    listen          192.168.50.9:8080;
}

vhost __defaultVhost__ {
    # HLS configuration optimized for stability
    hls {
        enabled         on;
        hls_fragment    3;      # 3 second fragments for stability (was 1)
        hls_window      6;      # 6 fragments window for better buffering
        hls_path        ./objs/nginx/html/[app]/;
        hls_m3u8_file   [app]/srs.m3u8;      # Fixed stream name to 'srs'
        hls_ts_file     [app]/srs-[seq].ts;   # Fixed stream name to 'srs'
    }
    
    # HTTP-FLV for lower latency alternative
    http_remux {
        enabled         on;
        mount           [vhost]/[app]/srs.flv;      # Fixed stream name to 'srs'
    }
    
    # Network optimization
    tcp_nodelay on;
    min_latency on;             # Enable low latency mode (was off)
    
    # Optimized play settings to fix green bars
    play {
        gop_cache off;          # DISABLE GOP cache to prevent artifacts
        queue_length 5;         # Reduced buffer to minimize lag (was 15)
        mw_latency 300;         # Reduced latency target (was 1000ms)
        time_jitter careful;    # More conservative jitter correction
        mix_correct on;         # Enable mix correction for better sync
        atc on;                 # Enable ATC for timestamp consistency
    }

    # Publish settings optimized for mobile
    publish {
        parse_sps on;           # Parse SPS headers for iOS compatibility
        firstpkt_timeout 20000; # Reduced timeout (was 30000)
        normal_timeout 7000;    # Reduced timeout (was 10000)
    }
    
    # Optimized chunk size for mobile streaming
    chunk_size 60000;           # Larger chunks for efficiency (was 4096)
    
    # Bandwidth management to prevent buffer overflow
    # Note: Using in_ack_size for bandwidth control instead of deprecated bandwidth block
    in_ack_size 2500000;        # ~3Mbps bandwidth limit (2.5MB window)
    
    # Security settings
    security {
        enabled off;
    }
    
    # Forward settings
    forward {
        enabled off;
    }
    
    # DVR settings
    dvr {
        enabled off;
    }
    
    # Additional mobile optimizations - FIXED REFER SETTINGS
    refer {
        enabled off;            # Disable referer checking for mobile compatibility
    }
    refer_play {
        enabled off;            # Disable play referer checking
    }
    refer_publish {
        enabled off;            # Disable publish referer checking
    }
}
