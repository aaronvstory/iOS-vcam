# SRS Configuration - iPhone RTMP Motion Smooth
# Optimized specifically for smooth motion handling with minimal choppiness
# Target: Best motion smoothness with acceptable latency (~300-400ms)

listen              1935;
max_connections     1000;
daemon              off;
srs_log_tank        console;

http_api {
    enabled         on;
    listen          1985;
}

http_server {
    enabled         on;
    listen          8080;
}

vhost __defaultVhost__ {
    # HLS optimized for motion smoothness
    hls {
        enabled         on;
        hls_fragment    2;      # 2-second fragments
        hls_window      5;      # 5 fragments = 10 seconds buffer
        hls_path        ./objs/nginx/html/[app]/;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
    }
    
    # HTTP-FLV for primary streaming
    http_remux {
        enabled         on;
        mount           [vhost]/[app]/[stream].flv;
    }
    
    # Motion-optimized network settings
    tcp_nodelay     on;         # Immediate TCP packet delivery
    min_latency     off;        # Allow buffering for motion smoothness
    
    # Motion-smooth play settings
    play {
        gop_cache       on;         # Enable GOP cache for motion smoothness
        queue_length    5;          # Higher buffer for motion handling
        mw_latency      350;        # Target 350ms for motion smoothness
        time_jitter     full;       # Full jitter correction for smooth motion
        mix_correct     on;         # Enable mix correction
        atc             on;         # Enable ATC for consistency
        mw_msgs         3;          # Allow batching for efficiency
    }

    # Motion-optimized publish settings
    publish {
        parse_sps       on;         # Keep for iOS compatibility
        firstpkt_timeout 20000;     # 20 seconds for stability
        normal_timeout  8000;       # 8 second timeout
        mr              off;        # Disable merged read
    }
    
    # Larger chunk size for motion efficiency
    chunk_size          16384;      # Larger chunks for motion data
    
    # Higher bandwidth buffering for motion
    in_ack_size         1000000;    # 1MB window for motion smoothness
    out_ack_size        1000000;    # Match for consistency
    
    # Disable unnecessary features
    refer {
        enabled         off;
    }
    refer_play {
        enabled         off;
    }
    refer_publish {
        enabled         off;
    }
    
    security {
        enabled         off;
    }
    
    forward {
        enabled         off;
    }
    
    dvr {
        enabled         off;
    }
}