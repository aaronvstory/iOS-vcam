# SRS Configuration - iPhone RTMP Smooth & Balanced
# Based on ultra_smooth_dynamic but with higher buffering for smoother motion
# Target: Smooth motion with minimal choppiness, slight latency trade-off

listen              1935;
max_connections     1000;
daemon              off;
srs_log_tank        console;

http_api {
    enabled         on;
    listen          1985;
}

http_server {
    enabled         on;
    listen          8080;
}

vhost __defaultVhost__ {
    # HLS optimized for smooth playback
    hls {
        enabled         on;
        hls_fragment    2;      # 2-second fragments for stability
        hls_window      4;      # 4 fragments = 8 seconds buffer
        hls_path        ./objs/nginx/html/[app]/;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
    }
    
    # HTTP-FLV for primary iPhone streaming
    http_remux {
        enabled         on;
        mount           [vhost]/[app]/[stream].flv;
    }
    
    # Balanced network settings
    tcp_nodelay     on;         # Immediate TCP packet delivery
    min_latency     on;         # Enable low-latency optimizations
    
    # Smoother play settings - higher buffer for motion smoothness
    play {
        gop_cache       off;        # Disable GOP cache for lower latency
        queue_length    3;          # Higher buffer for smooth motion (was 1)
        mw_latency      200;        # Target 200ms latency (was 100ms)
        time_jitter     careful;    # Enable careful jitter correction
        mix_correct     on;         # Enable mix correction for smoothness
        atc             on;         # Enable ATC for timestamp consistency
        mw_msgs         1;          # Send immediately
    }

    # Balanced publish settings
    publish {
        parse_sps       on;         # Keep for iOS compatibility
        firstpkt_timeout 15000;     # 15 seconds (was 10)
        normal_timeout  5000;       # 5 second timeout (was 3)
        mr              off;        # Disable merged read for speed
    }
    
    # Balanced chunk size
    chunk_size          8192;       # Larger chunks for efficiency (was 4096)
    
    # Moderate bandwidth buffering
    in_ack_size         500000;     # Larger window for stability (was 250000)
    out_ack_size        500000;     # Match for consistency
    
    # Disable unnecessary features
    refer {
        enabled         off;
    }
    refer_play {
        enabled         off;
    }
    refer_publish {
        enabled         off;
    }
    
    security {
        enabled         off;
    }
    
    forward {
        enabled         off;
    }
    
    dvr {
        enabled         off;
    }
}