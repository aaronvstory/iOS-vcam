name: Auto-Add OpenAI API Key

# Triggers when a new repo is created or when manually dispatched
on:
  # Manual trigger to add key to this repo
  workflow_dispatch:

  # Runs when PR is opened (checks if key exists)
  pull_request:
    types: [opened]

permissions:
  contents: read
  issues: write

jobs:
  check-and-add-key:
    runs-on: ubuntu-latest

    steps:
      - name: Check if OPENROUTER_API_KEY/OPENAI_API_KEY exists
        id: check-key
        continue-on-error: true
        run: |
          if [ -n "${{ secrets.OPENROUTER_API_KEY }}" ]; then
            echo "key_exists=true" >> $GITHUB_OUTPUT
            echo "key_name=OPENROUTER_API_KEY" >> $GITHUB_OUTPUT
            echo "‚úÖ OPENROUTER_API_KEY secret exists"
          elif [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "key_exists=true" >> $GITHUB_OUTPUT
            echo "key_name=OPENAI_API_KEY" >> $GITHUB_OUTPUT
            echo "‚úÖ OPENAI_API_KEY secret exists"
          else
            echo "key_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Missing OPENROUTER_API_KEY (preferred) or OPENAI_API_KEY"
          fi

      - name: Comment on PR if key is missing
        if: github.event_name == 'pull_request' && steps.check-key.outputs.key_exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ‚ö†Ô∏è Missing API Key Secret

            This repository is missing the API key secret required for Codex workflows.

            **Preferred (OpenRouter):**
            1. **Via GitHub CLI** (easiest):
               \`\`\`bash
               echo "YOUR_OPENROUTER_API_KEY" | gh secret set OPENROUTER_API_KEY --repo ${{ github.repository }}
               \`\`\`

            2. **Via GitHub UI**:
               - Go to [Settings ‚Üí Secrets ‚Üí Actions](https://github.com/${{ github.repository }}/settings/secrets/actions)
               - Click "New repository secret"
               - Name: \`OPENROUTER_API_KEY\`
               - Value: Your OpenRouter API key
               - Click "Add secret"

            **Fallback (OpenAI):**
            - You can also set \`OPENAI_API_KEY\` if you want to use OpenAI directly.

            Once added, Codex will automatically review PRs and create autofix PRs for CI failures.

            ---
            <sub>ü§ñ Automated check by [Auto-Add Key workflow](https://github.com/${{ github.repository }}/actions)</sub>
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Create issue if key is missing (on workflow dispatch)
        if: github.event_name == 'workflow_dispatch' && steps.check-key.outputs.key_exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ö†Ô∏è Missing API key secret',
              body: `## Setup Required

            This repository needs an API key secret to enable Codex workflows.

            **Preferred (OpenRouter):**

            \`\`\`bash
            echo "YOUR_OPENROUTER_API_KEY" | gh secret set OPENROUTER_API_KEY --repo ${{ github.repository }}
            \`\`\`

            **Fallback (OpenAI):**

            \`\`\`bash
            echo "YOUR_OPENAI_API_KEY" | gh secret set OPENAI_API_KEY --repo ${{ github.repository }}
            \`\`\`

            Or manually add via [Settings ‚Üí Secrets ‚Üí Actions](https://github.com/${{ github.repository }}/settings/secrets/actions)

            **What this enables:**
            - ‚úÖ Automatic PR code reviews
            - ‚úÖ Auto-fix PRs for failed CI builds
            - ‚úÖ Security vulnerability detection
            - ‚úÖ Code quality checks

            See [CODEX-GITHUB-SETUP.md](https://github.com/${{ github.repository }}/blob/master/CODEX-GITHUB-SETUP.md) for details.
            `,
              labels: ['setup-required', 'automation']
            });

            console.log(\`Created issue #\${issue.data.number}\`);
