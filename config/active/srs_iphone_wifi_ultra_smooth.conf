# SRS Configuration - iPhone WiFi ULTRA SMOOTH
# Prioritizes butter-smooth playback over low latency
# Ideal for: WiFi streaming where choppy playback is an issue
# Trade-off: 3-5 second latency for maximum smoothness

listen              1935;
max_connections     1000;
daemon              off;
srs_log_tank        console;

http_api {
    enabled         on;
    listen          1985;
}

http_server {
    enabled         on;
    listen          8080;
}

vhost __defaultVhost__ {
    # HLS optimized for MAXIMUM SMOOTHNESS
    hls {
        enabled         on;
        hls_fragment    3;      # 3-second fragments (longer = more stable)
        hls_window      8;      # 8 fragments = 24 seconds buffer window
        hls_path        ./objs/nginx/html/[app]/;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
    }

    # HTTP-FLV for primary iPhone streaming
    http_remux {
        enabled         on;
        mount           [vhost]/[app]/[stream].flv;
    }

    # SMOOTHNESS-FIRST network settings
    tcp_nodelay     on;         # Still keep TCP responsive
    min_latency     off;        # DISABLE aggressive latency - prioritize smoothness

    # ULTRA-SMOOTH play settings - BIG buffers for stability
    play {
        gop_cache       on;         # ENABLE GOP cache for smoother frames
        queue_length    12;         # LARGE buffer (12 frames) for smooth motion
        mw_latency      800;        # Target 800ms latency (generous)
        time_jitter     full;       # MAXIMUM jitter correction
        mix_correct     on;         # Enable mix correction
        atc             on;         # Enable ATC for timestamp consistency
        mw_msgs         2;          # Allow small batching for efficiency
    }

    # Generous publish settings - don't rush
    publish {
        parse_sps       on;         # Keep for iOS compatibility
        firstpkt_timeout 30000;     # 30 seconds - very generous
        normal_timeout  15000;      # 15 second timeout
        mr              on;         # ENABLE merged read for smoother ingestion
        mr_latency      500;        # Merged read latency target
    }

    # Larger chunk size for efficiency
    chunk_size          60000;      # LARGE chunks (60KB) for smooth delivery

    # Generous bandwidth buffering
    in_ack_size         1000000;    # 1MB window for stability
    out_ack_size        1000000;    # Match for consistency

    # Disable unnecessary features
    refer {
        enabled         off;
    }
    refer_play {
        enabled         off;
    }
    refer_publish {
        enabled         off;
    }

    security {
        enabled         off;
    }

    forward {
        enabled         off;
    }

    dvr {
        enabled         off;
    }
}
