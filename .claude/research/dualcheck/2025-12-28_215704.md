## /dualcheck - Dual-AI Verification Report
**Timestamp:** 2025-12-28 22:03:00
**Diff:** `.claude/research/dualcheck/2025-12-28_215704.diff`
**Files Checked:**
- CLAUDE.md (documentation)
- iOS-VCAM-Launcher.ps1 (USB streaming function)

---

### Summary

| Severity | Count |
|---|---:|
| CRITICAL | 0 |
| HIGH | 1 |
| MEDIUM | 2 |
| LOW | 0 |
| **Total** | **3** |

**Note:** Gemini CLI unavailable (API error). Report based on Codex analysis only.

---

### Issues (from Codex)

#### [HIGH] PowerShell 7-only syntax prevents the launcher from running
- **File:** `iOS-VCAM-Launcher.ps1:1472`
- **Details:** Line 1472 introduces the null-propagation (`?.`) and null-coalescing (`??`) operators inside `Start-MonibucaViaSshUsb`. Those constructs only exist in PowerShell 7+, but `iOS-VCAM-Launcher.bat` still invokes this script with `powershell.exe` (Windows PowerShell 5.1). On WinPS 5.1 the parser throws "Unexpected token '?'" before the function even loads, so option U can no longer start via the shipped batch file/exe.
- **Recommendation:** Replace `?.`/`??` with explicit `$temp = Get-Process ...; if ($temp) { $pname = $temp.ProcessName } else { ... }` style checks for Windows PowerShell 5.1 compatibility.

#### [MEDIUM] Port-readiness checks can return false positives
- **File:** `iOS-VCAM-Launcher.ps1:1562`
- **Details:** The readiness loops at lines 1562 and 1646 treat "any `Get-NetTCPConnection` row for local port 2222/1935" as success. That query also returns transient `TIME_WAIT`/`CLOSE_WAIT` rows or connections owned by other processes, so a stale socket can cause `$iproxyCheck`/`$monibucaCheck` to become non-null even though no listener is bound yet.
- **Recommendation:** Filter the poll with `Where-Object { $_.State -eq 'Listen' }` so only bound listening sockets count as ready.

#### [MEDIUM] SSH tunnel verification ignores which plink instance was started
- **File:** `iOS-VCAM-Launcher.ps1:1599`
- **Details:** The script checks `Get-Process -Name "plink"` to decide whether the tunnel launched. If a previous plink window was left open, that existing process satisfies the check and `$allReady` remains `true` even when the new tunnel immediately exited.
- **Recommendation:** Capture the `Process` object from `Start-Process ... -PassThru` and verify that specific PID is still running.

---

### Auto-Fix Plan

1. **[HIGH]** Replace PS7-only operators with PS5.1-compatible syntax
2. **[MEDIUM]** Add `-State Listen` filter to port checks
3. **[MEDIUM]** Use `-PassThru` to capture plink PID for verification

---

---

## Auto-Fix Log

### [HIGH] PowerShell 7-only syntax (line 1472)
✅ **Fixed:** Replaced `?.` and `??` operators with PS5.1-compatible syntax:
```powershell
# Before (PS7 only)
$pname = (Get-Process -Id $c.OwningProcess -ErrorAction SilentlyContinue)?.ProcessName ?? "(unknown)"

# After (PS5.1 compatible)
$proc = Get-Process -Id $c.OwningProcess -ErrorAction SilentlyContinue
$pname = if ($proc) { $proc.ProcessName } else { "(unknown)" }
```

### [MEDIUM] Port-readiness false positives (lines 1562, 1646)
✅ **Fixed:** Added `Where-Object { $_.State -eq 'Listen' }` filter to both iproxy and Monibuca port checks to only match actual listening sockets.

### [MEDIUM] SSH tunnel verification (line 1599)
✅ **Fixed:** Now counts plink processes before and after launching to detect if a new instance was actually started:
```powershell
$plinkCountBefore = @(Get-Process -Name "plink" -ErrorAction SilentlyContinue).Count
# ... Start-Process ...
$plinkCountAfter = @(Get-Process -Name "plink" -ErrorAction SilentlyContinue).Count
if ($plinkCountAfter -gt $plinkCountBefore) { ... }
```

### Validation
- ✅ Smoke test passed: `SUCCESS: EXE is running`
- ✅ All fixes applied successfully

---

### Raw Codex Output

```
[
  {
    "severity": "HIGH",
    "title": "PowerShell 7-only syntax prevents the launcher from running",
    "file": "iOS-VCAM-Launcher.ps1",
    "line": 1472
  },
  {
    "severity": "MEDIUM",
    "title": "Port-readiness checks can return false positives",
    "file": "iOS-VCAM-Launcher.ps1",
    "line": 1562
  },
  {
    "severity": "MEDIUM",
    "title": "SSH tunnel verification ignores which plink instance was started",
    "file": "iOS-VCAM-Launcher.ps1",
    "line": 1599
  }
]
```
